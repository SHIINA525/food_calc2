<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>フード量計算（多頭・犬猫対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #1976d2;
      --bg: #f5f5f5;
      --card: #ffffff;
      --text-main: #222;
      --text-sub: #555;
      --accent-red: #e53935;
      --border: #e0e0e0;
      --radius: 16px;
      --shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Yu Gothic", "Hiragino Sans", "Noto Sans JP", sans-serif;
      font-size: 16px;
      line-height: 1.6;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 520px;
    }

    h1 {
      text-align: center;
      font-size: 26px;
      margin: 8px 0 20px;
      letter-spacing: .08em;
    }

    h2 { font-size: 22px; margin: 0 0 8px; }
    h3 { font-size: 18px; margin: 0 0 8px; }
    h4 { font-size: 16px; margin: 16px 0 4px; }
    p  { margin: 4px 0; }

    /* タブ */
    .tab-bar {
      display: flex;
      margin: 0 auto 20px;
      background: #e0e0e0;
      padding: 4px;
      border-radius: 999px;
    }

    .tab-button {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 10px 0;
      font-size: 15px;
      background: transparent;
      color: #666;
      font-weight: 600;
    }

    .tab-button.active {
      background: var(--primary);
      color: #fff;
      box-shadow: var(--shadow);
    }

    /* カード */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px 16px 20px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .section-title {
      margin-bottom: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
    }

    /* フォーム */
    .field { margin-bottom: 12px; }

    label {
      display: block;
      font-size: 14px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 10px 12px;
      font-size: 15px;
      border-radius: 999px;
      border: 1px solid var(--border);
      outline: none;
      background: #fafafa;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary { background: var(--primary); color: #fff; }
    .btn-outline {
      background: #fff;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    .btn-danger {
      background: var(--accent-red);
      color: #fff;
    }

    .button-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    small { font-size: 12px; color: var(--text-sub); }
    .muted { color: var(--text-sub); font-size: 14px; }

    /* 結果表示 */
    .result-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 15px;
    }

    .result-label { color: var(--text-sub); }
    .result-value { font-weight: 600; }

    .highlight {
      color: var(--accent-red);
      font-weight: 700;
      font-size: 18px;
    }

    /* グラフ */
    .graph-container {
      margin-top: 8px;
      background: #fafafa;
      border-radius: 12px;
      padding: 8px;
      border: 1px dashed var(--border);
    }

    canvas {
      width: 100%;
      max-width: 480px;
      height: 160px;
      display: block;
      margin-top: 4px;
    }

    .weight-history {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .history-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 2px;
      gap: 4px;
    }

    .history-text {
      flex: 1;
    }

    .history-buttons button {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      color: #555;
    }

    /* セクション切り替え */
    .species-section { display: none; }
    .species-section.active { display: block; }

    @media (min-width: 560px) {
      body { padding: 24px; font-size: 17px; }
      h1  { font-size: 28px; }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>フード量計算</h1>

  <!-- タブ -->
  <div class="tab-bar">
    <button id="tabDog" class="tab-button active" type="button">犬の計算</button>
    <button id="tabCat" class="tab-button" type="button">猫の計算</button>
  </div>

  <!-- 犬セクション -->
  <section id="dogSection" class="species-section active">
    <div class="card">
      <div class="section-title">
        <h2>犬の情報</h2>
      </div>

      <div class="field">
        <h3>犬の一覧</h3>
        <label for="dogSelect">登録されている犬</label>
        <select id="dogSelect">
          <option value="">犬を選択</option>
        </select>
      </div>

      <div class="field">
        <h3>犬を追加</h3>
        <label for="newDogName">名前</label>
        <input id="newDogName" type="text" placeholder="例）てつろう">
      </div>
      <div class="field button-row">
        <button class="btn-primary" type="button" onclick="addDog()">犬を登録する</button>
      </div>
      <small>※ 登録後、一覧から名前を選ぶとその子の画面が開きます。</small>
    </div>

    <div id="dogDetailCard" class="card" style="display:none;">
      <div class="section-title">
        <h2 id="dogTitle">犬：</h2>
      </div>

      <!-- 日付＋体重入力 -->
      <div class="field">
        <label for="dogDate">日付</label>
        <input id="dogDate" type="date">
      </div>
      <div class="field">
        <label for="dogWeight">体重（kg）</label>
        <input id="dogWeight" type="number" step="0.1" min="0" placeholder="例）12.3">
      </div>
      <div class="field button-row">
        <button class="btn-outline" type="button" onclick="addWeight('dog')">体重を追加</button>
        <span class="muted">※ 日付を空欄のままにすると、今日の日付で登録されます。</span>
      </div>

      <!-- 体重履歴とグラフ -->
      <div class="graph-container">
        <div class="muted">体重の推移</div>
        <canvas id="dogCanvas" width="400" height="160"></canvas>
        <div id="dogHistory" class="weight-history"></div>
      </div>

      <!-- 給餌設定 -->
      <h3 style="margin-top:14px;">給餌設定</h3>

      <div class="field">
        <label for="dogFoodKcal">フードのカロリー（kcal / 100 g）</label>
        <input id="dogFoodKcal" type="number" step="1" min="0" placeholder="例）360">
      </div>

      <div class="field">
        <label for="dogActivity">活動レベル</label>
        <select id="dogActivity">
          <option value="neutered">避妊・去勢している成犬（1.6）</option>
          <option value="intact">避妊・去勢していない成犬（1.8）</option>
          <option value="diet">減量（1.0）</option>
          <option value="senior">高齢犬（1.4）</option>
        </select>
      </div>

      <div class="field">
        <label for="dogMeals">1日の食事回数</label>
        <select id="dogMeals">
          <option value="1">1回</option>
          <option value="2" selected>2回（デフォルト）</option>
          <option value="3">3回</option>
          <option value="4">4回</option>
        </select>
      </div>

      <!-- 計算結果 -->
      <h3 style="margin-top:14px;">計算結果</h3>
      <p class="muted">※ 小数点はすべて四捨五入して整数で表示します。</p>

      <div class="result-row">
        <div class="result-label">RER（安静時必要エネルギー）</div>
        <div id="dogRer" class="result-value">-- kcal/日</div>
      </div>

      <div class="result-row">
        <div class="result-label">DER（1日の必要エネルギー）</div>
        <div id="dogDer" class="result-value">-- kcal/日</div>
      </div>

      <div class="result-row">
        <div class="result-label">1日の給餌量</div>
        <div><span id="dogDailyGram" class="highlight">--</span> g/日</div>
      </div>

      <div class="result-row">
        <div class="result-label">1回あたりの給餌量</div>
        <div><span id="dogPerMealGram" class="highlight">--</span> g/回</div>
      </div>

      <!-- 犬ごと削除 -->
      <div class="field button-row" style="margin-top:16px; justify-content:flex-end;">
        <button class="btn-danger" type="button" onclick="deletePet('dog')">この犬を削除</button>
      </div>
    </div>
  </section>

  <!-- 猫セクション -->
  <section id="catSection" class="species-section">
    <div class="card">
      <div class="section-title">
        <h2>猫の情報</h2>
      </div>

      <div class="field">
        <h3>猫の一覧</h3>
        <label for="catSelect">登録されている猫</label>
        <select id="catSelect">
          <option value="">猫を選択</option>
        </select>
      </div>

      <div class="field">
        <h3>猫を追加</h3>
        <label for="newCatName">名前</label>
        <input id="newCatName" type="text" placeholder="例）ひまわり">
      </div>
      <div class="field button-row">
        <button class="btn-primary" type="button" onclick="addCat()">猫を登録する</button>
      </div>
      <small>※ 登録後、一覧から名前を選ぶとその子の画面が開きます。</small>
    </div>

    <div id="catDetailCard" class="card" style="display:none;">
      <div class="section-title">
        <h2 id="catTitle">猫：</h2>
      </div>

      <!-- 日付＋体重入力 -->
      <div class="field">
        <label for="catDate">日付</label>
        <input id="catDate" type="date">
      </div>
      <div class="field">
        <label for="catWeight">体重（kg）</label>
        <input id="catWeight" type="number" step="0.1" min="0" placeholder="例）4.2">
      </div>
      <div class="field button-row">
        <button class="btn-outline" type="button" onclick="addWeight('cat')">体重を追加</button>
        <span class="muted">※ 日付を空欄のままにすると、今日の日付で登録されます。</span>
      </div>

      <!-- 体重履歴とグラフ -->
      <div class="graph-container">
        <div class="muted">体重の推移</div>
        <canvas id="catCanvas" width="400" height="160"></canvas>
        <div id="catHistory" class="weight-history"></div>
      </div>

      <!-- 給餌設定 -->
      <h3 style="margin-top:14px;">給餌設定</h3>

      <div class="field">
        <label for="catFoodKcal">フードのカロリー（kcal / 100 g）</label>
        <input id="catFoodKcal" type="number" step="1" min="0" placeholder="例）360">
      </div>

      <div class="field">
        <label for="catActivity">活動レベル</label>
        <select id="catActivity">
          <option value="neutered">避妊・去勢している成猫（1.2）</option>
          <option value="intact">避妊・去勢していない成猫（1.4）</option>
          <option value="kitten">7ヶ月〜1歳の子猫（2.0）</option>
          <option value="diet">減量（0.8）</option>
          <option value="senior">高齢猫（1.1）</option>
        </select>
      </div>

      <div class="field">
        <label for="catMeals">1日の食事回数</label>
        <select id="catMeals">
          <option value="1">1回</option>
          <option value="2" selected>2回（デフォルト）</option>
          <option value="3">3回</option>
          <option value="4">4回</option>
        </select>
      </div>

      <!-- 計算結果 -->
      <h3 style="margin-top:14px;">計算結果</h3>
      <p class="muted">※ 小数点はすべて四捨五入して整数で表示します。</p>

      <div class="result-row">
        <div class="result-label">RER（安静時必要エネルギー）</div>
        <div id="catRer" class="result-value">-- kcal/日</div>
      </div>

      <div class="result-row">
        <div class="result-label">DER（1日の必要エネルギー）</div>
        <div id="catDer" class="result-value">-- kcal/日</div>
      </div>

      <div class="result-row">
        <div class="result-label">1日の給餌量</div>
        <div><span id="catDailyGram" class="highlight">--</span> g/日</div>
      </div>

      <div class="result-row">
        <div class="result-label">1回あたりの給餌量</div>
        <div><span id="catPerMealGram" class="highlight">--</span> g/回</div>
      </div>

      <!-- 猫ごと削除 -->
      <div class="field button-row" style="margin-top:16px; justify-content:flex-end;">
        <button class="btn-danger" type="button" onclick="deletePet('cat')">この猫を削除</button>
      </div>
    </div>
  </section>
</div>

<script>
  // ====== ユーティリティ ======
  function loadList(key) {
    return JSON.parse(localStorage.getItem(key) || "[]");
  }
  function saveList(key, list) {
    localStorage.setItem(key, JSON.stringify(list));
  }
  function todayISO() {
    const d = new Date();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${d.getFullYear()}-${m}-${day}`;
  }

  // ====== 一覧セレクト更新 ======
  function refreshSelect(species) {
    const key = species === "dog" ? "dogs" : "cats";
    const selectId = species === "dog" ? "dogSelect" : "catSelect";
    const list = loadList(key);
    const select = document.getElementById(selectId);

    select.innerHTML = `<option value="">${species === "dog" ? "犬" : "猫"}を選択</option>`;
    list.forEach((item, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = item.name;
      select.appendChild(opt);
    });
  }

  // ====== 新規登録 ======
  function addDog() {
    const nameInput = document.getElementById("newDogName");
    const name = nameInput.value.trim();
    if (!name) {
      alert("犬の名前を入力してください。");
      return;
    }
    const list = loadList("dogs");
    list.push({ name, weights: [] });
    saveList("dogs", list);
    nameInput.value = "";
    refreshSelect("dog");
    document.getElementById("dogSelect").value = String(list.length - 1);
    onSelectChange("dog");
  }

  function addCat() {
    const nameInput = document.getElementById("newCatName");
    const name = nameInput.value.trim();
    if (!name) {
      alert("猫の名前を入力してください。");
      return;
    }
    const list = loadList("cats");
    list.push({ name, weights: [] });
    saveList("cats", list);
    nameInput.value = "";
    refreshSelect("cat");
    document.getElementById("catSelect").value = String(list.length - 1);
    onSelectChange("cat");
  }

  // ====== ペット削除（犬・猫） ======
  function deletePet(species) {
    const listKey  = species === "dog" ? "dogs" : "cats";
    const selectId = species === "dog" ? "dogSelect" : "catSelect";
    const detailId = species === "dog" ? "dogDetailCard" : "catDetailCard";

    const select = document.getElementById(selectId);
    const idx = select.value;
    if (idx === "") return;

    const list = loadList(listKey);
    const pet = list[idx];
    if (!pet) return;

    const label = species === "dog" ? "この犬" : "この猫";
    if (!confirm(`${label}「${pet.name}」を削除しますか？\n（体重記録もすべて消えます）`)) return;

    list.splice(idx, 1);
    saveList(listKey, list);

    // セレクト更新 & 詳細非表示 & 表示リセット
    refreshSelect(species);
    select.value = "";
    document.getElementById(detailId).style.display = "none";
    clearOutputs(species);
  }

  function clearOutputs(species) {
    const isDog = species === "dog";
    const rerId    = isDog ? "dogRer"          : "catRer";
    const derId    = isDog ? "dogDer"          : "catDer";
    const dailyId  = isDog ? "dogDailyGram"    : "catDailyGram";
    const perMealId= isDog ? "dogPerMealGram"  : "catPerMealGram";
    const canvasId = isDog ? "dogCanvas"       : "catCanvas";
    const historyId= isDog ? "dogHistory"      : "catHistory";

    document.getElementById(rerId).textContent = "-- kcal/日";
    document.getElementById(derId).textContent = "-- kcal/日";
    document.getElementById(dailyId).textContent = "--";
    document.getElementById(perMealId).textContent = "--";

    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById(historyId).innerHTML = "";
  }

  // ====== セレクト変更時 ======
  function onSelectChange(species) {
    const selectId = species === "dog" ? "dogSelect" : "catSelect";
    const detailId = species === "dog" ? "dogDetailCard" : "catDetailCard";
    const titleId  = species === "dog" ? "dogTitle" : "catTitle";
    const listKey  = species === "dog" ? "dogs" : "cats";

    const select = document.getElementById(selectId);
    const idx = select.value;
    const list = loadList(listKey);
    const card = document.getElementById(detailId);

    if (idx === "" || !list[idx]) {
      card.style.display = "none";
      clearOutputs(species);
      return;
    }

    const pet = list[idx];
    card.style.display = "block";
    document.getElementById(titleId).textContent =
      (species === "dog" ? "犬：" : "猫：") + pet.name;

    if (species === "dog") {
      document.getElementById("dogWeight").value = "";
      document.getElementById("dogDate").value = "";
    } else {
      document.getElementById("catWeight").value = "";
      document.getElementById("catDate").value = "";
    }

    // 日付順にソートして保存
    pet.weights.sort((a, b) => a.date.localeCompare(b.date));
    saveList(listKey, list);

    renderWeights(species, pet.weights);
    recalc(species);
  }

  // ====== 体重追加 ======
  function addWeight(species) {
    const selectId = species === "dog" ? "dogSelect" : "catSelect";
    const weightId = species === "dog" ? "dogWeight" : "catWeight";
    const dateId   = species === "dog" ? "dogDate"   : "catDate";
    const listKey  = species === "dog" ? "dogs"      : "cats";

    const select = document.getElementById(selectId);
    const idx = select.value;
    if (idx === "") {
      alert(`${species === "dog" ? "犬" : "猫"}を選択してください。`);
      return;
    }

    const weightInput = document.getElementById(weightId);
    const dateInput   = document.getElementById(dateId);

    const w = parseFloat(weightInput.value);
    if (isNaN(w) || w <= 0) {
      alert("正しい体重（kg）を入力してください。");
      return;
    }

    let date = dateInput.value;
    if (!date) {
      date = todayISO();
    }

    const list = loadList(listKey);
    const pet = list[idx];

    pet.weights.push({ date, value: w });
    pet.weights.sort((a, b) => a.date.localeCompare(b.date));
    saveList(listKey, list);

    weightInput.value = "";
    // 日付は残す（連続入力しやすくする）

    renderWeights(species, pet.weights);
    recalc(species);
  }

  // ====== 体重編集・削除（1件ずつ） ======
  function editWeight(species, index) {
    const listKey = species === "dog" ? "dogs" : "cats";
    const selectId= species === "dog" ? "dogSelect" : "catSelect";

    const select = document.getElementById(selectId);
    const idx = select.value;
    const list = loadList(listKey);
    const pet = list[idx];
    if (!pet || !pet.weights[index]) return;

    const item = pet.weights[index];
    const input = prompt("新しい体重（kg）を入力してください", item.value);
    if (input === null) return;

    const w = parseFloat(input);
    if (isNaN(w) || w <= 0) {
      alert("正しい体重を入力してください。");
      return;
    }

    item.value = w;
    pet.weights.sort((a, b) => a.date.localeCompare(b.date));
    saveList(listKey, list);

    renderWeights(species, pet.weights);
    recalc(species);
  }

  function deleteWeight(species, index) {
    const listKey = species === "dog" ? "dogs" : "cats";
    const selectId= species === "dog" ? "dogSelect" : "catSelect";

    const select = document.getElementById(selectId);
    const idx = select.value;
    const list = loadList(listKey);
    const pet = list[idx];
    if (!pet || !pet.weights[index]) return;

    if (!confirm("この体重記録を削除しますか？")) return;

    pet.weights.splice(index, 1);
    saveList(listKey, list);

    renderWeights(species, pet.weights);
    recalc(species);
  }

  // ====== グラフ・履歴描画（日付順） ======
  function renderWeights(species, weights) {
    const canvasId  = species === "dog" ? "dogCanvas" : "catCanvas";
    const historyId = species === "dog" ? "dogHistory" : "catHistory";
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext("2d");
    const w = canvas.width;
    const h = canvas.height;

    ctx.clearRect(0, 0, w, h);
    const histDiv = document.getElementById(historyId);
    histDiv.innerHTML = "";

    if (!weights || weights.length === 0) {
      ctx.fillStyle = "#999";
      ctx.font = "13px -apple-system, 'Yu Gothic'";
      ctx.fillText("まだ体重データがありません。", 10, h / 2);
      return;
    }

    const values = weights.map(x => x.value);
    const minV = Math.min.apply(null, values);
    const maxV = Math.max.apply(null, values);
    const padding = 20;
    const xStep = (w - padding * 2) / Math.max(1, (weights.length - 1));
    const range = maxV - minV || 1;

    // 横軸
    ctx.strokeStyle = "#bbdefb";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, h - padding);
    ctx.lineTo(w - padding, h - padding);
    ctx.stroke();

    // 線
    ctx.strokeStyle = "#1976d2";
    ctx.lineWidth = 2;
    ctx.beginPath();
    weights.forEach((item, i) => {
      const x = padding + xStep * i;
      const y = padding + (1 - (item.value - minV) / range) * (h - padding * 2);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // 点
    ctx.fillStyle = "#1976d2";
    weights.forEach((item, i) => {
      const x = padding + xStep * i;
      const y = padding + (1 - (item.value - minV) / range) * (h - padding * 2);
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    });

    // 履歴（編集・削除付き）
    weights.forEach((item, i) => {
      const row = document.createElement("div");
      row.className = "history-row";

      const text = document.createElement("div");
      text.className = "history-text";
      text.textContent = `${item.date}: ${item.value.toFixed(1)} kg`;

      const btns = document.createElement("div");
      btns.className = "history-buttons";

      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.textContent = "編集";
      editBtn.onclick = () => editWeight(species, i);

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.textContent = "削除";
      delBtn.onclick = () => deleteWeight(species, i);

      btns.appendChild(editBtn);
      btns.appendChild(delBtn);

      row.appendChild(text);
      row.appendChild(btns);
      histDiv.appendChild(row);
    });
  }

  // ====== 活動係数 ======
  function getActivityFactor(species, value) {
    if (species === "dog") {
      switch (value) {
        case "intact":   return 1.8;
        case "neutered": return 1.6;
        case "diet":     return 1.0;
        case "senior":   return 1.4;
        default:         return 1.6;
      }
    } else {
      // cat
      switch (value) {
        case "intact":   return 1.4;
        case "neutered": return 1.2;
        case "kitten":   return 2.0;  // 7ヶ月〜1歳の子猫
        case "diet":     return 0.8;
        case "senior":   return 1.1;
        default:         return 1.2;
      }
    }
  }

  // ====== 計算 ======
  function recalc(species) {
    const isDog   = species === "dog";
    const selectId= isDog ? "dogSelect"       : "catSelect";
    const listKey = isDog ? "dogs"           : "cats";

    const select  = document.getElementById(selectId);
    const idx     = select.value;
    const list    = loadList(listKey);
    const pet     = list[idx];

    const rerId   = isDog ? "dogRer"         : "catRer";
    const derId   = isDog ? "dogDer"         : "catDer";
    const dailyId = isDog ? "dogDailyGram"   : "catDailyGram";
    const perMealId = isDog ? "dogPerMealGram" : "catPerMealGram";
    const foodId  = isDog ? "dogFoodKcal"    : "catFoodKcal";
    const actId   = isDog ? "dogActivity"    : "catActivity";
    const mealId  = isDog ? "dogMeals"       : "catMeals";

    const rerEl   = document.getElementById(rerId);
    const derEl   = document.getElementById(derId);
    const dailyEl = document.getElementById(dailyId);
    const perMealEl = document.getElementById(perMealId);

    let rerText = "-- kcal/日";
    let derText = "-- kcal/日";
    let dailyText = "--";
    let perMealText = "--";

    if (!pet || !pet.weights || pet.weights.length === 0) {
      rerEl.textContent = rerText;
      derEl.textContent = derText;
      dailyEl.textContent = dailyText;
      perMealEl.textContent = perMealText;
      return;
    }

    // 最新の体重（配列は日付順なので末尾を使用）
    const latest = pet.weights[pet.weights.length - 1].value;
    const rer = 70 * Math.pow(latest, 0.75);

    const actSelect = document.getElementById(actId);
    const factor = getActivityFactor(species, actSelect.value);
    const der = rer * factor;

    const foodKcalPer100 = parseFloat(document.getElementById(foodId).value);
    const meals = parseInt(document.getElementById(mealId).value, 10) || 1;

    const rerRound = Math.round(rer);
    const derRound = Math.round(der);

    rerText = `${rerRound} kcal/日`;
    derText = `${derRound} kcal/日`;

    if (!isNaN(foodKcalPer100) && foodKcalPer100 > 0) {
      const kcalPerGram = foodKcalPer100 / 100;
      let dailyGram = der / kcalPerGram;
      let perMealGram = dailyGram / meals;

      dailyGram = Math.round(dailyGram);
      perMealGram = Math.round(perMealGram);

      dailyText = String(dailyGram);
      perMealText = String(perMealGram);
    }

    rerEl.textContent = rerText;
    derEl.textContent = derText;
    dailyEl.textContent = dailyText;
    perMealEl.textContent = perMealText;
  }

  // ====== タブ切り替え ======
  function switchTab(tab) {
    const dogTab = document.getElementById("tabDog");
    const catTab = document.getElementById("tabCat");
    const dogSec = document.getElementById("dogSection");
    const catSec = document.getElementById("catSection");

    if (tab === "dog") {
      dogTab.classList.add("active");
      catTab.classList.remove("active");
      dogSec.classList.add("active");
      catSec.classList.remove("active");
    } else {
      dogTab.classList.remove("active");
      catTab.classList.add("active");
      dogSec.classList.remove("active");
      catSec.classList.add("active");
    }
  }

  document.getElementById("tabDog").addEventListener("click", () => switchTab("dog"));
  document.getElementById("tabCat").addEventListener("click", () => switchTab("cat"));

  document.getElementById("dogSelect").addEventListener("change", () => onSelectChange("dog"));
  document.getElementById("catSelect").addEventListener("change", () => onSelectChange("cat"));

  ["dogFoodKcal", "dogActivity", "dogMeals"].forEach(id => {
    document.getElementById(id).addEventListener("change", () => recalc("dog"));
  });
  ["catFoodKcal", "catActivity", "catMeals"].forEach(id => {
    document.getElementById(id).addEventListener("change", () => recalc("cat"));
  });

  // 初期表示
  (function init() {
    refreshSelect("dog");
    refreshSelect("cat");
  })();
</script>
</body>
</html>
